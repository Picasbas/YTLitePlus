name: Reparer Dependance Manquante (Force)
on: workflow_dispatch

jobs:
  fix-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Ajouter libundirect et modifier Makefile
        run: |
          # 1. Configuration de l'utilisateur
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # 2. NETTOYAGE DES IDENTIFIANTS (C'est la partie qui corrige votre erreur 128)
          # On supprime l'en-tête d'autorisation qui bloque le téléchargement des dépôts publics externes
          git config --local --unset-all http.https://github.com/.extraheader

          # 3. Ajout du sous-module (avec .git à la fin pour être sûr)
          if [ ! -d "Tweaks/libundirect" ]; then
            echo "Ajout du sous-module..."
            git submodule add https://github.com/PoomSmart/libundirect.git Tweaks/libundirect
          else
            echo "Le dossier existe déjà."
          fi

          # 4. Modification du Makefile
          if [ -f "Tweaks/Makefile" ]; then
            echo "Modification de Tweaks/Makefile..."
            # On nettoie d'abord au cas où le script a déjà tourné partiellement
            sed -i '/libundirect/d' Tweaks/Makefile
            # On insère la ligne correctement
            sed -i '/YTUHD/i SUBPROJECTS += libundirect' Tweaks/Makefile
          fi

          # 5. Validation et Envoi (Méthode forcée avec Token)
          git add .
          git commit -m "Fix: Ajout dependance libundirect" || echo "Rien à commiter"
          
          # On pousse en utilisant le token explicitement dans l'URL pour contourner le nettoyage fait à l'étape 2
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
