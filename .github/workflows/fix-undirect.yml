name: Reparer Dependance (Methode API V3)
on: workflow_dispatch

jobs:
  fix-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      - name: Telecharger Lib et Modifier Makefile
        run: |
          # 1. Configuration Git
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

          # 2. Nettoyage préventif
          rm -rf Tweaks/libundirect
          
          # 3. Téléchargement via API GitHub (Plus sûr)
          echo "Téléchargement de l'archive..."
          
          # On télécharge l'archive TAR.GZ au lieu de ZIP (souvent plus fiable sur Linux)
          # On suit les redirections (-L)
          curl -L https://api.github.com/repos/PoomSmart/libundirect/tarball/master -o libundirect.tar.gz
          
          # Vérification de la taille du fichier (si < 100 octets, c'est une erreur)
          FILESIZE=$(wc -c < "libundirect.tar.gz")
          if [ $FILESIZE -lt 100 ]; then
              echo "Echec téléchargement master, tentative sur main..."
              curl -L https://api.github.com/repos/PoomSmart/libundirect/tarball/main -o libundirect.tar.gz
          fi
          
          # 4. Extraction
          mkdir -p Tweaks/libundirect
          # On extrait en ignorant le premier niveau de dossier (--strip-components=1)
          tar -xzf libundirect.tar.gz -C Tweaks/libundirect --strip-components=1
          rm libundirect.tar.gz
          
          # 5. Modification du Makefile
          if [ -f "Tweaks/Makefile" ]; then
            echo "Mise à jour du Makefile..."
            sed -i '/libundirect/d' Tweaks/Makefile
            sed -i '/YTUHD/i SUBPROJECTS += libundirect' Tweaks/Makefile
          fi

          # 6. Validation et Envoi
          git add .
          git commit -m "Fix: Ajout libundirect (via API Tarball)" || echo "Rien à commiter"
          
          # Poussée forcée avec le token
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:main
